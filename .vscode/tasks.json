{
  "version": "2.0.0",
  "options": { "shell": { "executable": "/bin/bash", "args": ["-lc"] } },
  "inputs": [
    {
      "id": "serialPort",
      "type": "promptString",
      "description": "Enter the ESP32-S3 serial port (e.g. /dev/ttyUSB0 or /dev/ttyACM0)",
      "default": "/dev/ttyUSB0"
    }
  ],
  "tasks": [
    {
      "label": "ESP: One-time init (set-target + defconfig)",
      "type": "shell",
      "command": "PORT='${input:serialPort}'; if [ -z \"$PORT\" ]; then PORT=$(ls -1 /dev/serial/by-id/* 2>/dev/null | head -n1 || true); [ -z \"$PORT\" ] && PORT=$(ls -1 /dev/ttyACM* /dev/ttyUSB* 2>/dev/null | head -n1 || true); fi; echo Using serial port: ${PORT:?no serial port found}; podman run --rm -it --userns=keep-id --group-add keep-groups --device=\"$PORT\" --privileged --security-opt label=disable -v ${workspaceFolder}:/work:z -v ${userHome}/.espressif:/root/.espressif:z -w /work espressif/idf:latest bash -lc 'idf.py -B build -p '\"$PORT\"' flash'",
      "problemMatcher": []
    },
    {
      "label": "ESP: Build (Podman)",
      "type": "shell",
      "command": "podman run --rm -it -v ${workspaceFolder}:/work:z -v ${userHome}/.espressif:/root/.espressif:z -w /work espressif/idf:latest bash -lc 'idf.py -B build build'",
      "problemMatcher": [
        {
          "owner": "cpp",
          "fileLocation": ["relative", "${workspaceFolder}"],
          "pattern": {
            "regexp": "^([^:\\s][^:]*):(\\d+):(\\d+):\\s+(warning|error|note):\\s+(.*)$",
            "file": 1,
            "line": 2,
            "column": 3,
            "severity": 4,
            "message": 5
          }
        }
      ]
    },
    {
      "label": "ESP: Menuconfig (Podman)",
      "type": "shell",
      "presentation": { "reveal": "always", "panel": "dedicated" },
      "command": "podman run --rm -it -e TERM=xterm-256color -v ${workspaceFolder}:/work:z -v ${userHome}/.espressif:/root/.espressif:z -w /work espressif/idf:latest bash -lc 'idf.py -B build menuconfig && cmake -S . -B build -G Ninja -DCMAKE_EXPORT_COMPILE_COMMANDS=ON'",
      "problemMatcher": []
    },
    {
      "label": "ESP: Flash (Podman, choose port)",
      "type": "shell",
      "dependsOn": "ESP: Build (Podman)",
      "command": "podman run --rm -it --device=${input:serialPort} --privileged -v ${workspaceFolder}:/work:z -v ${userHome}/.espressif:/root/.espressif:z -w /work espressif/idf:latest bash -lc 'idf.py -B build -p ${input:serialPort} flash'",
      "problemMatcher": []
    },
    {
      "label": "ESP: Monitor (Podman, choose port)",
      "type": "shell",
      "command": "podman run --rm -it --device=${input:serialPort} --privileged -v ${workspaceFolder}:/work:z -v ${userHome}/.espressif:/root/.espressif:z -w /work espressif/idf:latest bash -lc 'idf.py -B build -p ${input:serialPort} monitor'",
      "problemMatcher": []
    },
    {
      "label": "ESP: Build+Flash+Monitor (Podman, auto port)",
      "type": "shell",
      "command": "podman run --rm -it --device=${input:serialPort} --privileged -v ${workspaceFolder}:/work:z -v ${userHome}/.espressif:/root/.espressif:z -w /work espressif/idf:latest bash -lc 'idf.py -B build build && idf.py -B build -p ${input:serialPort} flash monitor'",
      "problemMatcher": [
        {
          "owner": "cpp",
          "fileLocation": ["relative", "${workspaceFolder}"],
          "pattern": {
            "regexp": "^([^:\\s][^:]*):(\\d+):(\\d+):\\s+(warning|error|note):\\s+(.*)$",
            "file": 1,
            "line": 2,
            "column": 3,
            "severity": 4,
            "message": 5
          }
        }
      ]
    },
    {
      "label": "ESP: Clean (keep sdkconfig)",
      "type": "shell",
      "command": "podman run --rm -it -v ${workspaceFolder}:/work:z -v ${userHome}/.espressif:/root/.espressif:z -w /work espressif/idf:latest bash -lc 'idf.py -B build clean && rm -rf build/CMakeFiles build/CMakeCache.txt'",
      "problemMatcher": []
    },
    {
      "label": "ESP: Distclean (removes sdkconfig!)",
      "type": "shell",
      "command": "podman run --rm -it -v ${workspaceFolder}:/work:z -v ${userHome}/.espressif:/root/.espressif:z -w /work espressif/idf:latest bash -lc 'idf.py -B build fullclean && rm -rf build'",
      "problemMatcher": []
    }
  ]
}
