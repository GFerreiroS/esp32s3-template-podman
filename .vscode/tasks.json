{
  "version": "2.0.0",
  "options": {
    "shell": { "executable": "/bin/bash", "args": ["-lc"] }
  },
  "tasks": [
    {
      "label": "ESP: Build (Podman)",
      "type": "shell",
      "command": "podman run --rm -it -v ${workspaceFolder}:/work:z -v ${userHome}/.espressif:/root/.espressif:z -w /work espressif/idf:latest bash -lc 'idf.py -B build build'",
      "problemMatcher": [
        {
          "owner": "cpp",
          "fileLocation": ["relative", "${workspaceFolder}"],
          "pattern": {
            "regexp": "^([^:\\s][^:]*):(\\d+):(\\d+):\\s+(warning|error|note):\\s+(.*)$",
            "file": 1,
            "line": 2,
            "column": 3,
            "severity": 4,
            "message": 5
          }
        }
      ]
    },
    {
      "label": "ESP: Menuconfig (Podman)",
      "type": "shell",
      "presentation": { "reveal": "always", "panel": "dedicated" },
      "command": "podman run --rm -it -e TERM=xterm-256color -v ${workspaceFolder}:/work:z -v ${userHome}/.espressif:/root/.espressif:z -w /work espressif/idf:latest bash -lc 'idf.py -B build menuconfig && cmake -S . -B build -G Ninja -DCMAKE_EXPORT_COMPILE_COMMANDS=ON'",
      "problemMatcher": []
    },
    {
      "label": "ESP: Flash (Podman)",
      "type": "shell",
      "dependsOn": "ESP: Build (Podman)",
      "command": "PORT=$(jq -r '.serialPort // empty' .vscode/env.json 2>/dev/null || true); if [ -z \"$PORT\" ]; then echo 'Serial port not configured. Run ./setup.sh -d <port>'; exit 1; fi; echo Using port: $PORT; podman run --rm -it --device=\"$PORT\" --privileged -v ${workspaceFolder}:/work:z -v ${userHome}/.espressif:/root/.espressif:z -w /work espressif/idf:latest bash -lc 'idf.py -B build -p '\"$PORT\"' flash'",
      "problemMatcher": []
    },
    {
      "label": "ESP: Monitor (Podman)",
      "type": "shell",
      "command": "PORT=$(jq -r '.serialPort // empty' .vscode/env.json 2>/dev/null || true); if [ -z \"$PORT\" ]; then echo 'Serial port not configured. Run ./setup.sh -d <port>'; exit 1; fi; echo Using port: $PORT; podman run --rm -it --device=\"$PORT\" --privileged -v ${workspaceFolder}:/work:z -v ${userHome}/.espressif:/root/.espressif:z -w /work espressif/idf:latest bash -lc 'idf.py -B build -p '\"$PORT\"' monitor'",
      "problemMatcher": []
    },
    {
      "label": "ESP: Build+Flash+Monitor (Podman)",
      "type": "shell",
      "command": "PORT=$(jq -r '.serialPort // empty' .vscode/env.json 2>/dev/null || true); if [ -z \"$PORT\" ]; then echo 'Serial port not configured. Run ./setup.sh -d <port>'; exit 1; fi; echo Using port: $PORT; podman run --rm -it --device=\"$PORT\" --privileged -v ${workspaceFolder}:/work:z -v ${userHome}/.espressif:/root/.espressif:z -w /work espressif/idf:latest bash -lc 'idf.py -B build build && idf.py -B build -p '\"$PORT\"' flash monitor'",
      "problemMatcher": [
        {
          "owner": "cpp",
          "fileLocation": ["relative", "${workspaceFolder}"],
          "pattern": {
            "regexp": "^([^:\\s][^:]*):(\\d+):(\\d+):\\s+(warning|error|note):\\s+(.*)$",
            "file": 1,
            "line": 2,
            "column": 3,
            "severity": 4,
            "message": 5
          }
        }
      ]
    },
    {
      "label": "ESP: Clean (keep sdkconfig)",
      "type": "shell",
      "command": "podman run --rm -it -v ${workspaceFolder}:/work:z -v ${userHome}/.espressif:/root/.espressif:z -w /work espressif/idf:latest bash -lc 'idf.py -B build clean && rm -rf build/CMakeFiles build/CMakeCache.txt'",
      "problemMatcher": []
    },
    {
      "label": "ESP: Distclean (removes sdkconfig!)",
      "type": "shell",
      "command": "podman run --rm -it -v ${workspaceFolder}:/work:z -v ${userHome}/.espressif:/root/.espressif:z -w /work espressif/idf:latest bash -lc 'idf.py -B build distclean && rm -rf build'",
      "problemMatcher": []
    }
  ]
}
